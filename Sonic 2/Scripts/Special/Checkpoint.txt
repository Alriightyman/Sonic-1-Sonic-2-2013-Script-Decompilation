//--------------------Sonic 1 / Sonic 2 Checkpoint Script--------------------//
//--------Scripted by Christian Whitehead 'The Taxman' & Simon Thomley 'Stealth'--------//
//-----------------Unpacked By Rubberduckycooly's Script Unpacker-----------------------//

//-------Aliases-------//
#alias 11: TYPE_CHECKPOINT

// Function declarations
#function Checkpoint_Function11


#array Checkpoint_array17:(165,198,231,264,297,330,263)

function Checkpoint_Function11
	ArrayPos0=3DScene.NoVertices
	ArrayPos1=3DScene.NoFaces
	TempValue0=Object.Value3
	TempValue0>>=22
	TempValue0&=3
	GetArrayValue(ArrayPos2,TempValue0,Halfpipe_array13)
	TempValue0=0
	while TempValue0<7
		FaceBuffer[ArrayPos1].Flag=FACE_TEXTURED_C
		FaceBuffer[ArrayPos1].a=ArrayPos0
		VertexBuffer[ArrayPos0].x=VertexBuffer[ArrayPos2].x
		VertexBuffer[ArrayPos0].y=VertexBuffer[ArrayPos2].y
		VertexBuffer[ArrayPos0].z=VertexBuffer[ArrayPos2].z
		GetArrayValue(VertexBuffer[ArrayPos0].u,Object.Frame,Checkpoint_array17)
		VertexBuffer[ArrayPos0].v=256
		ArrayPos0++
		FaceBuffer[ArrayPos1].b=ArrayPos0
		VertexBuffer[ArrayPos0].x=VertexBuffer[ArrayPos2].x
		VertexBuffer[ArrayPos0].y=VertexBuffer[ArrayPos2].y
		VertexBuffer[ArrayPos0].z=VertexBuffer[ArrayPos2].z
		VertexBuffer[ArrayPos0].u=0x800
		VertexBuffer[ArrayPos0].v=0x800
		ArrayPos0++
		FaceBuffer[ArrayPos1].c=ArrayPos0
		VertexBuffer[ArrayPos0].x=VertexBuffer[ArrayPos2].x
		VertexBuffer[ArrayPos0].y=VertexBuffer[ArrayPos2].y
		VertexBuffer[ArrayPos0].z=VertexBuffer[ArrayPos2].z
		VertexBuffer[ArrayPos0].u=16
		VertexBuffer[ArrayPos0].v=16
		ArrayPos0++
		FaceBuffer[ArrayPos1].d=ArrayPos0
		VertexBuffer[ArrayPos0].x=VertexBuffer[ArrayPos2].x
		VertexBuffer[ArrayPos0].y=VertexBuffer[ArrayPos2].y
		VertexBuffer[ArrayPos0].z=VertexBuffer[ArrayPos2].z
		ArrayPos0++
		3DScene.NoVertices+=4
		3DScene.NoFaces++
		ArrayPos1++
		ArrayPos2+=4
		TempValue0++
	loop
endfunction


sub ObjectMain
	switch Object.State
	case 0
		if Object.Value0<16
			Object.Value0++
		else
			Object.Value3>>=22
			Object.Value3<<=22
			Object.Value3+=0x300000
			ResetObjectEntity(11,TypeName[BlankObject],0,0,0)
			Object.Value0=0
			Object.State++
		endif
		break
	case 1
		Object.AnimationTimer++
		if Object.AnimationTimer==4
			Object.AnimationTimer=0
			Object.Frame++
			Object.Frame%=7
		endif
		CallFunction(Checkpoint_Function11)
		foreach TypeGroup[4],PlayerObjectPos
			TempValue1=Object.Value3
			TempValue1-=0x20000
			TempValue2=Object.Value3
			TempValue2+=0x20000
			if Object[PlayerObjectPos].Value14>TempValue1
				if Object[PlayerObjectPos].Value14<TempValue2
					Object.Value7=80
					Object.DrawOrder=5
					if options.vsMode==0
						Object.Value9=4
						Object.Value9+=Stage.PlayerListPos
					else
						Object.Value9=4
					endif
					Object.State++
					if stage.player2Enabled==1
						TempValue0=Object[2].Value0
						TempValue0+=Object[3].Value0
					else
						TempValue0=Object[2].Value0
					endif
					GetArrayValue(TempValue1,SpecialSetup_constant3,SpecialSetup_constant4)
					if TempValue0>=TempValue1
						Object.Value8=0
						CreateTempObject(TypeName[TextMessage],0,0,0)
						Object[TempObjectPos].DrawOrder=5
						PlaySfx(SFXName[StarPost],0)
					else
						Object.Value8=1
						CreateTempObject(TypeName[TextMessage],1,0,0)
						Object[TempObjectPos].DrawOrder=5
						PlaySfx(SFXName[Fail],0)
					endif
					Object.Value10=Object.Value8
					if Object.Value9==6
						Object.Value10+=2
					endif
				endif
			endif
		floop
		break
	case 2
		Sin(Object.Value7,Object.Angle)
		Object.Value7>>=7
		Object.Value7+=80
		Object.Angle+=24
		Object.Angle&=511
		if Object.Value0<120
			if Object.Value0<20
				CallFunction(Checkpoint_Function11)
			endif
			Object.Value0++
		else
			Object.Value0=0
			Object.State++
		endif
		break
	case 3
		if Object.Scale>0
			Object.Scale-=16
		else
			if Object.Value8==0
				Object.State++
			else
				ResetObjectEntity(Object.EntityNo,TypeName[BlankObject],0,0,0)
				ResetObjectEntity(20,TypeName[SpecialFinish],0,0,0)
				Object[20].Priority=PRIORITY_ACTIVE
			endif
		endif
		break
	case 4
		if Object.Value0<10
			Object.Value0++
		else
			CreateTempObject(TypeName[TextMessage],2,0,0)
			Object[TempObjectPos].DrawOrder=5
			SpecialSetup_constant3++
			GetArrayValue(Object[TempObjectPos].Value4,SpecialSetup_constant3,SpecialSetup_constant4)
			ResetObjectEntity(Object.EntityNo,TypeName[BlankObject],0,0,0)
		endif
		break

	endswitch
endsub


sub ObjectDraw
	switch Object.State
	case 2
		DrawSpriteScreenXY(Object.Value9,Screen.CenterX,80)
		DrawSpriteScreenXY(Object.Value10,Screen.CenterX,Object.Value7)
		break
	case 3
		DrawSpriteScreenFX(Object.Value9,FX_SCALE,Screen.CenterX,80)
		DrawSpriteScreenFX(Object.Value10,FX_SCALE,Screen.CenterX,Object.Value7)
		break

	endswitch
endsub


sub ObjectStartup
	LoadSpriteSheet("Special/Objects.gif")
	SpriteFrame(-24,-24,48,48,463,42)
	SpriteFrame(-24,-24,48,48,366,155)
	SpriteFrame(-24,-24,48,48,463,328)
	SpriteFrame(-24,-24,48,48,463,377)
	SpriteFrame(-48,-24,96,48,415,122)
	SpriteFrame(-48,-24,96,48,415,171)
	SpriteFrame(-48,-24,96,48,415,220)
endsub

sub RSDK
	LoadSpriteSheet("Global/Display.gif")
	SetEditorIcon(Icon0,SingleIcon,-16,-16,32,32,1,143)
endsub
