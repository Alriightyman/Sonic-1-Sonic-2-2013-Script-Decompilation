//--------------------Sonic 1 / Sonic 2 Chaos Emerald Script--------------------//
//--------Scripted by Christian Whitehead 'The Taxman' & Simon Thomley 'Stealth'--------//
//-----------------Unpacked By Rubberduckycooly's Script Unpacker-----------------------//

//-------Aliases-------//
#alias 15: TYPE_CHAOSEMERALD

// Function declarations
#function ChaosEmerald_Function14



function ChaosEmerald_Function14
	MatrixRotateXYZ(MAT_WORLD,Object[0].Value17,Object[0].Value18,Object[0].Value19)
	MatrixTranslateXYZ(MAT_TEMP,Object[0].Value14,Object[0].Value15,Object[0].Value16)
	MatrixMultiply(MAT_WORLD,MAT_TEMP)
	ArrayPos0=3DScene.NoVertices
	ArrayPos1=3DScene.NoFaces
	FaceBuffer[ArrayPos1].Flag=FACE_TEXTURED_D
	FaceBuffer[ArrayPos1].a=ArrayPos0
	VertexBuffer[ArrayPos0].x=0
	VertexBuffer[ArrayPos0].y=-0x3800
	VertexBuffer[ArrayPos0].z=Object.Value8
	VertexBuffer[ArrayPos0].u=116
	VertexBuffer[ArrayPos0].v=50
	ArrayPos2=ArrayPos0
	ArrayPos0++
	TransformVertices(MAT_WORLD,ArrayPos2,ArrayPos0)
	FaceBuffer[ArrayPos1].b=ArrayPos0
	VertexBuffer[ArrayPos0].x=VertexBuffer[ArrayPos2].x
	VertexBuffer[ArrayPos0].y=VertexBuffer[ArrayPos2].y
	VertexBuffer[ArrayPos0].z=VertexBuffer[ArrayPos2].z
	VertexBuffer[ArrayPos0].u=0x600
	VertexBuffer[ArrayPos0].v=0x600
	ArrayPos0++
	FaceBuffer[ArrayPos1].c=ArrayPos0
	VertexBuffer[ArrayPos0].x=VertexBuffer[ArrayPos2].x
	VertexBuffer[ArrayPos0].y=VertexBuffer[ArrayPos2].y
	VertexBuffer[ArrayPos0].z=VertexBuffer[ArrayPos2].z
	VertexBuffer[ArrayPos0].u=17
	VertexBuffer[ArrayPos0].v=16
	ArrayPos0++
	FaceBuffer[ArrayPos1].d=ArrayPos0
	VertexBuffer[ArrayPos0].x=VertexBuffer[ArrayPos2].x
	VertexBuffer[ArrayPos0].y=VertexBuffer[ArrayPos2].y
	VertexBuffer[ArrayPos0].z=VertexBuffer[ArrayPos2].z
	ArrayPos0++
	ArrayPos1++
	3DScene.NoVertices+=4
	3DScene.NoFaces++
	ArrayPos2=ArrayPos0
	ArrayPos0++
	FaceBuffer[ArrayPos1].Flag=FACE_SPRITE_3D
	FaceBuffer[ArrayPos1].a=ArrayPos2
	VertexBuffer[ArrayPos2].x=0
	VertexBuffer[ArrayPos2].y=Object.Value7
	VertexBuffer[ArrayPos2].z=Object.Value8
	TransformVertices(MAT_WORLD,ArrayPos2,ArrayPos0)
	VertexBuffer[ArrayPos2].u=15
	VertexBuffer[ArrayPos2].v=0
	FaceBuffer[ArrayPos1].b=ArrayPos0
	VertexBuffer[ArrayPos0].x=VertexBuffer[ArrayPos2].x
	VertexBuffer[ArrayPos0].y=VertexBuffer[ArrayPos2].y
	VertexBuffer[ArrayPos0].z=VertexBuffer[ArrayPos2].z
	VertexBuffer[ArrayPos0].u=Object.Frame
	VertexBuffer[ArrayPos0].v=0
	ArrayPos0++
	FaceBuffer[ArrayPos1].c=ArrayPos0
	VertexBuffer[ArrayPos0].x=VertexBuffer[ArrayPos2].x
	VertexBuffer[ArrayPos0].y=VertexBuffer[ArrayPos2].y
	VertexBuffer[ArrayPos0].z=VertexBuffer[ArrayPos2].z
	VertexBuffer[ArrayPos0].u=Object.Scale
	VertexBuffer[ArrayPos0].v=0
	ArrayPos0++
	FaceBuffer[ArrayPos1].d=ArrayPos0
	VertexBuffer[ArrayPos0].x=VertexBuffer[ArrayPos2].x
	VertexBuffer[ArrayPos0].y=VertexBuffer[ArrayPos2].y
	VertexBuffer[ArrayPos0].z=VertexBuffer[ArrayPos2].z
	3DScene.NoVertices+=4
	3DScene.NoFaces++
endfunction


sub ObjectMain
	switch Object.State
	case 0
		Object[11].Type=TypeName[BlankObject]
		foreach TypeGroup[4],PlayerObjectPos
			TempValue1=Object.Value3
			TempValue1-=0x20000
			TempValue2=Object.Value3
			TempValue2+=0x20000
			if Object[PlayerObjectPos].Value14>TempValue1
				if Object[PlayerObjectPos].Value14<TempValue2
					ResetObjectEntity(11,TypeName[BlankObject],0,0,0)
					Object.Scale=0
					Object.DrawOrder=5
					Object.Frame=Stage.ActNo
					Object.State++
					if stage.player2Enabled==1
						TempValue0=Object[2].Value0
						TempValue0+=Object[3].Value0
						Object[2].ControlMode=-1
						Object[2].Left=0
						Object[2].Right=0
						Object[3].ControlMode=-1
						Object[3].Left=0
						Object[3].Right=0
					else
						TempValue0=Object[2].Value0
						Object[2].ControlMode=-1
						Object[2].Left=0
						Object[2].Right=0
					endif
					GetArrayValue(TempValue1,SpecialSetup_staticVar3,SpecialSetup_staticVar4)
					if TempValue0>=TempValue1
						Object.Value9=0
					else
						Object.Value9=1
					endif
					Object.Value8=0x14000
				endif
			endif
		floop
		if Stage.ActNo==7
			GetArrayValue(TempValue0,SpecialSetup_staticVar3,SpecialSetup_staticVar4)
			if Object[10].Value1>TempValue0
				Object.Value0++
				Object.Value0&=1
				if Object.Value0==0
					RotatePalette(0,129,141,0)
				endif
			endif
		endif
		break
	case 1
		Sin(Object.Value7,Object.Angle)
		Object.Value7-=0x1C00
		Object.Angle+=12
		Object.Angle&=511
		Music.Volume--
		if Object.Value9==0
			if Stage.ActNo==7
				Object.Value0++
				Object.Value0&=1
				if Object.Value0==0
					RotatePalette(0,129,141,0)
				endif
			endif
			if Object.Scale<512
				Object.Scale+=4
				Object.Value8-=512
			else
				StopMusic()
				PlaySfx(SFXName[Emerald],0)
				SpecialSetup_staticVar0=1
				Object.State++
			endif
		else
			if Object.Scale<384
				Object.Scale+=4
				Object.Value8-=512
			else
				StopMusic()
				CreateTempObject(TypeName[TextMessage],1,0,0)
				Object[TempObjectPos].DrawOrder=5
				Object.State++
			endif
			if Object[0].Value23>4
				if Object.AnimationTimer==0
					Object[0].Value23--
				endif
				Object.AnimationTimer++
				Object.AnimationTimer&=7
			endif
		endif
		CallFunction(ChaosEmerald_Function14)
		break
	case 2
		Sin(Object.Value7,Object.Angle)
		Object.Value7-=0x1C00
		Object.Angle+=12
		Object.Angle&=511
		CallFunction(ChaosEmerald_Function14)
		if Object.Value9==1
			if Object[0].Value23>4
				if Object.AnimationTimer==0
					Object[0].Value23--
				endif
				Object.AnimationTimer++
				Object.AnimationTimer&=7
			endif
			if Object.Scale>0
				Object.Scale-=2
				Object.Value8+=256
			endif
		else
			if Stage.ActNo==7
				TempValue0=Object.Value0
				TempValue0&=1
				if TempValue0==0
					RotatePalette(0,129,141,0)
				endif
			endif
		endif
		Object.Value0++
		if Object.Value0==180
			ResetObjectEntity(20,TypeName[SpecialFinish],0,0,0)
			Object[20].Priority=PRIORITY_ACTIVE
		endif
		break
	endswitch
endsub


sub ObjectStartup
	LoadSpriteSheet("Special/Objects.gif")
	SpriteFrame(-12,-4,24,8,313,165)
	SpriteFrame(-10,-10,20,20,1,239)
	SpriteFrame(-10,-10,20,20,22,239)
	SpriteFrame(-10,-10,20,20,43,239)
	SpriteFrame(-10,-10,20,20,64,239)
	SpriteFrame(-10,-10,20,20,85,239)
	SpriteFrame(-10,-10,20,20,106,239)
	SpriteFrame(-10,-10,20,20,127,239)
endsub

sub RSDK
	LoadSpriteSheet("Global/Display.gif")
	SetEditorIcon(Icon0,SingleIcon,-16,-16,32,32,1,143)
endsub
