//--------------------Sonic 1 / Sonic 2 Checkpoint 2PVS Script--------------------//
//--------Scripted by Christian Whitehead 'The Taxman' & Simon Thomley 'Stealth'--------//
//-----------------Unpacked By Rubberduckycooly's Script Unpacker-----------------------//

//-------Aliases-------//
#alias 17: TYPE_CHECKPOINT2PVS

// Function declarations
#function Checkpoint2PVS_Function15


#array Checkpoint2PVS_array20:(165,198,231,264,297,330,263)

function Checkpoint2PVS_Function15
	ArrayPos0=3DScene.NoVertices
	ArrayPos1=3DScene.NoFaces
	TempValue0=Object.Value3
	TempValue0>>=22
	TempValue0&=3
	GetArrayValue(ArrayPos2,TempValue0,Halfpipe_array13)
	TempValue0=0
	while TempValue0<7
		FaceBuffer[ArrayPos1].Flag=FACE_TEXTURED_C
		FaceBuffer[ArrayPos1].a=ArrayPos0
		VertexBuffer[ArrayPos0].x=VertexBuffer[ArrayPos2].x
		VertexBuffer[ArrayPos0].y=VertexBuffer[ArrayPos2].y
		VertexBuffer[ArrayPos0].z=VertexBuffer[ArrayPos2].z
		GetArrayValue(VertexBuffer[ArrayPos0].u,Object.Frame,Checkpoint2PVS_array20)
		VertexBuffer[ArrayPos0].v=256
		ArrayPos0++
		FaceBuffer[ArrayPos1].b=ArrayPos0
		VertexBuffer[ArrayPos0].x=VertexBuffer[ArrayPos2].x
		VertexBuffer[ArrayPos0].y=VertexBuffer[ArrayPos2].y
		VertexBuffer[ArrayPos0].z=VertexBuffer[ArrayPos2].z
		VertexBuffer[ArrayPos0].u=0x800
		VertexBuffer[ArrayPos0].v=0x800
		ArrayPos0++
		FaceBuffer[ArrayPos1].c=ArrayPos0
		VertexBuffer[ArrayPos0].x=VertexBuffer[ArrayPos2].x
		VertexBuffer[ArrayPos0].y=VertexBuffer[ArrayPos2].y
		VertexBuffer[ArrayPos0].z=VertexBuffer[ArrayPos2].z
		VertexBuffer[ArrayPos0].u=16
		VertexBuffer[ArrayPos0].v=16
		ArrayPos0++
		FaceBuffer[ArrayPos1].d=ArrayPos0
		VertexBuffer[ArrayPos0].x=VertexBuffer[ArrayPos2].x
		VertexBuffer[ArrayPos0].y=VertexBuffer[ArrayPos2].y
		VertexBuffer[ArrayPos0].z=VertexBuffer[ArrayPos2].z
		ArrayPos0++
		3DScene.NoVertices+=4
		3DScene.NoFaces++
		ArrayPos1++
		ArrayPos2+=4
		TempValue0++
	loop
endfunction


sub ObjectMain
	switch Object.State
	case 0
		if Object.Value0<16
			Object.Value0++
		else
			Object.Value3>>=22
			Object.Value3<<=22
			Object.Value3+=0x300000
			ResetObjectEntity(11,TypeName[BlankObject],0,0,0)
			Object.Value0=0
			Object.State++
		endif
		break
	case 1
		Object.AnimationTimer++
		if Object.AnimationTimer==4
			Object.AnimationTimer=0
			Object.Frame++
			Object.Frame%=7
		endif
		CallFunction(Checkpoint2PVS_Function15)
		TempValue3=0
		foreach TypeGroup[4],PlayerObjectPos
			if TempValue3==0
				TempValue1=Object.Value3
				TempValue1-=0x20000
				TempValue2=Object.Value3
				TempValue2+=0x20000
				if Object[PlayerObjectPos].Value14>TempValue1
					if Object[PlayerObjectPos].Value14<TempValue2
						Object.Value7=80
						Object.DrawOrder=5
						if Object[2].Value0==Object[3].Value0
							Object.Value9=-1
							CreateTempObject(TypeName[TextMessage],8,0,0)
						else
							if Object[2].Value0>Object[3].Value0
								Object[2].Value19++
								Object.Value9=4
								Object.Value9+=Stage.PlayerListPos
								if vs.playerID==0
									CreateTempObject(TypeName[TextMessage],6,0,0)
								else
									CreateTempObject(TypeName[TextMessage],7,0,0)
								endif
							else
								if ReceiveValue==-1
									Object[3].Value19++
								endif
								Object.Value9=4
								Object.Value9+=vs.player2Type
								if vs.playerID==0
									CreateTempObject(TypeName[TextMessage],7,0,0)
								else
									CreateTempObject(TypeName[TextMessage],6,0,0)
								endif
							endif
						endif
						switch SpecialSetup_staticVar3
						case 0
							Object[2].Value20=Object[2].Value0
							Object[3].Value20=Object[3].Value0
							break
						case 1
							Object[2].Value21=Object[2].Value0
							Object[3].Value21=Object[3].Value0
							break
						case 2
							Object[2].Value22=Object[2].Value0
							Object[3].Value22=Object[3].Value0
							break
						endswitch
						Object[TempObjectPos].DrawOrder=5
						PlaySfx(SFXName[StarPost],0)
						Object.Value10=0
						if Object.Value9==6
							Object.Value10+=2
						endif
						TempValue3=1
						Object.State++
					endif
				endif
			endif
		floop
		break
	case 2
		Sin(Object.Value7,Object.Angle)
		Object.Value7>>=7
		Object.Value7+=80
		Object.Angle+=24
		Object.Angle&=511
		if Object.Value0<120
			if Object.Value0<20
				CallFunction(Checkpoint2PVS_Function15)
			endif
			Object.Value0++
		else
			Object.Value0=0
			Object.State++
		endif
		break
	case 3
		if Object.Scale>0
			Object.Scale-=16
		else
			SpecialSetup_staticVar3++
			if SpecialSetup_staticVar3==3
				Object.State=5
				Object[2].ControlMode=-1
				Object[3].ControlMode=-1
			else
				Object.State++
			endif
		endif
		break
	case 4
		if Object.Value0<10
			Object.Value0++
		else
			CreateTempObject(TypeName[TextMessage],5,0,0)
			Object[TempObjectPos].DrawOrder=5
			ResetObjectEntity(Object.EntityNo,TypeName[BlankObject],0,0,0)
		endif
		break
	case 5
		options.touchControls=0
		if Object.Value0<320
			Object.Value0+=8
			SetScreenFade(248,248,248,Object.Value0)
		else
			Object.Value0=248
			Object.State++
			SetScreenFade(248,248,248,255)
		endif
		break
	case 6
		options.touchControls=0
		if Object.Value0>0
			Object.Value0-=8
			Music.Volume-=5
		else
			if vs.playerID==0
				vs.checkpoint1P=Object[2].Value20
				TempValue0=Object[2].Value21
				TempValue0<<=8
				vs.checkpoint1P+=TempValue0
				TempValue0=Object[2].Value22
				TempValue0<<=16
				vs.checkpoint1P+=TempValue0
				vs.checkpoint2P=Object[3].Value20
				TempValue0=Object[3].Value21
				TempValue0<<=8
				vs.checkpoint2P+=TempValue0
				TempValue0=Object[3].Value22
				TempValue0<<=16
				vs.checkpoint2P+=TempValue0
			else
				vs.checkpoint1P=Object[3].Value20
				TempValue0=Object[3].Value21
				TempValue0<<=8
				vs.checkpoint1P+=TempValue0
				TempValue0=Object[3].Value22
				TempValue0<<=16
				vs.checkpoint1P+=TempValue0
				vs.checkpoint2P=Object[2].Value20
				TempValue0=Object[2].Value21
				TempValue0<<=8
				vs.checkpoint2P+=TempValue0
				TempValue0=Object[2].Value22
				TempValue0<<=16
				vs.checkpoint2P+=TempValue0
			endif
			Stage.ActiveList=PRESENTATION_STAGE
			Stage.ListPos=3
			StopMusic()
			LoadStage()
		endif
		SetScreenFade(Object.Value0,Object.Value0,Object.Value0,255)
		break
	endswitch
endsub


sub ObjectDraw
	if Object.Value9>-1
		switch Object.State
		case 2
			DrawSpriteScreenXY(Object.Value9,Screen.CenterX,80)
			DrawSpriteScreenXY(Object.Value10,Screen.CenterX,Object.Value7)
			break
		case 3
			DrawSpriteScreenFX(Object.Value9,FX_SCALE,Screen.CenterX,80)
			DrawSpriteScreenFX(Object.Value10,FX_SCALE,Screen.CenterX,Object.Value7)
			break
		endswitch
	endif
endsub


sub ObjectStartup
	LoadSpriteSheet("Special/Objects.gif")
	SpriteFrame(-24,-24,48,48,463,42)
	SpriteFrame(-24,-24,48,48,366,155)
	SpriteFrame(-24,-24,48,48,463,328)
	SpriteFrame(-24,-24,48,48,463,377)
	SpriteFrame(-48,-24,96,48,415,122)
	SpriteFrame(-48,-24,96,48,415,171)
	SpriteFrame(-48,-24,96,48,415,220)
	if options.vsMode==1
		foreach TypeName[Checkpoint],ArrayPos0
			Object[ArrayPos0].Type=TypeName[Checkpoint2PVS]
		floop
		foreach TypeName[ChaosEmerald],ArrayPos0
			Object[ArrayPos0].Type=TypeName[Checkpoint2PVS]
		floop
		foreach TypeName[RingsReminder],ArrayPos0
			Object[ArrayPos0].Type=TypeName[BlankObject]
		floop
	endif
endsub

sub RSDK
	LoadSpriteSheet("Global/Display.gif")
	SetEditorIcon(Icon0,SingleIcon,-16,-16,32,32,1,143)
endsub
