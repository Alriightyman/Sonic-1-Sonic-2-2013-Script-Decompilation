//--------------------Sonic 1 / Sonic 2 Star Post Script--------------------//
//--------Scripted by Christian Whitehead 'The Taxman' & Simon Thomley 'Stealth'--------//
//-----------------Unpacked By Rubberduckycooly's Script Unpacker-----------------------//

//-------Aliases-------//
#alias 18: TYPE_STARPOST

// Function declarations
#function StarPost_Function87
#function StarPost_Function88



function StarPost_Function87
	DrawSprite(2)
endfunction


function StarPost_Function88
	CreateTempObject(TypeName[StarPost],0,Object.XPos,Object.YPos)
endfunction


sub ObjectMain
	switch Object.State
	case 0
		foreach TypeGroup[256],PlayerObjectPos
			if Object[PlayerObjectPos].Value16==0
				PlayerObjectCollision(C_TOUCH,Object.EntityNo,-8,-44,8,20,PlayerObjectPos,0x10000,0x10000,0x10000,0x10000)
				if CheckResult==1
					if options.vsMode==1
						if PlayerObjectPos==0
							vs.restartX1=Object.XPos
							vs.restartY1=Object.YPos
							Object.Value10=1
						else
							vs.restartX2=Object.XPos
							vs.restartY2=Object.YPos
							Object.Value10=0
						endif
						Object.State=4
					else
						starPostID=Object.EntityNo
						foreach TypeName[StarPost],ArrayPos0
							if Object[ArrayPos0].PropertyValue<Object.PropertyValue
								Object[ArrayPos0].State=1
								Object[ArrayPos0].Animation=2
								Object[ArrayPos0].Value0=0
							endif
						floop
						if specialStage.emeralds<127
							if options.gameMode!=2
								if Object[0].Value0>=50
									Object.State=2
									Object.Value4=4
									Object.Value3=0
									Object.Value6=0
									Object.Value5=0
									Object.Value7=0
								else
									Object.State=1
								endif
							else
								Object.State=1
							endif
						else
							Object.State=1
						endif
					endif
					recMilliSeconds=Stage.MilliSeconds
					recSeconds=Stage.Seconds
					recMinutes=Stage.Minutes
					recWaterState=stage.waterState
					recWaterLevel=Stage.WaterLevel
					Object.Value0=384
					if Object.Priority!=PRIORITY_XBOUNDS_DESTROY
						Object.Priority=PRIORITY_ACTIVE
					endif
					Object.Animation=1
					PlaySfx(SFXName[StarPost],0)
				endif
			endif
		floop
		break
	case 1
		Object.AnimationTimer++
		Object.AnimationTimer&=7
		Object.Frame=Object.AnimationTimer
		Object.Frame>>=2
		break
	case 2
		Object.Value5+=18
		Object.Value5&=511
		Object.Value6+=4
		Object.Value6&=511
		if Object.Value3<128
			Object.Value7++
		else
			if Object.Value3>472
				Object.Value7--
			endif
		endif
		Object.Value3++
		if Object.Value3==600
			Object.State=1
			Object.Value3=0
			Object.Value4=0
			if Object.Priority!=PRIORITY_XBOUNDS_DESTROY
				Object.Priority=PRIORITY_ACTIVE_BOUNDS
			endif
		endif
		Object.AnimationTimer++
		Object.AnimationTimer&=7
		Object.Frame=Object.AnimationTimer
		Object.Frame>>=2
		TempValue0=Object.Value7
		TempValue0>>=2
		FlipSign(TempValue0)
		TempValue1=Object.Value7
		TempValue1>>=2
		if Object.Value3>60
			PlayerObjectCollision(C_TOUCH,Object.EntityNo,TempValue0,-64,TempValue1,-56,0,0x10000,0x10000,0x10000,0x10000)
			if CheckResult==1
				PlaySfx(SFXName[Warp],0)
				Object.State=3
				Object.Priority=PRIORITY_ACTIVE_PAUSED
				Stage.State=3
				Object[0].ControlMode=-1
				fadeColor=208
				fadeColor<<=16
				TempValue0=255
				TempValue0<<=8
				fadeColor+=TempValue0
				fadeColor+=224
				Object.Value9=0
			endif
		endif
		break
	case 3
		options.touchControls=0
		Music.Volume-=2
		Object.Value9+=8
		SetScreenFade(208,255,224,Object.Value9)
		if Object.Value9==0x400
			specialStage.nextZone=Stage.ListPos
			Stage.ActiveList=SPECIAL_STAGE
			Stage.ListPos=specialStage.listPos
			LoadStage()
		endif
		break
	case 4
		PlayerObjectPos=Object.Value10
		PlayerObjectCollision(C_TOUCH,Object.EntityNo,-8,-44,8,20,PlayerObjectPos,0x10000,0x10000,0x10000,0x10000)
		if CheckResult==1
			if PlayerObjectPos==0
				vs.restartX1=Object.XPos
				vs.restartY1=Object.YPos
			else
				vs.restartX2=Object.XPos
				vs.restartY2=Object.YPos
			endif
			if Object.Animation!=1
				Object.Value0=384
			endif
			if Object.Priority!=PRIORITY_XBOUNDS_DESTROY
				Object.Priority=PRIORITY_ACTIVE
			endif
			Object.Animation=1
			Object.State=1
			PlaySfx(SFXName[StarPost],0)
		endif
		Object.AnimationTimer++
		Object.AnimationTimer&=7
		Object.Frame=Object.AnimationTimer
		Object.Frame>>=2
		break

	endswitch
	if Object.Animation==1
		Cos(Object.Value1,Object.Value0)
		Object.Value1*=-0x500
		Sin(Object.Value2,Object.Value0)
		Object.Value2*=0x500
		Object.Value1+=Object.XPos
		Object.Value2+=Object.YPos
		Object.Value2-=0x1A0000
		Object.Value0+=32
		if Object.Value0>0x580
			Object.Value0=0
			Object.Animation=2
			if Object.Priority!=PRIORITY_XBOUNDS_DESTROY
				if Object.Value4==0
					Object.Priority=PRIORITY_ACTIVE_BOUNDS
				endif
			endif
		endif
	endif
endsub


sub ObjectDraw
	switch Object.Animation
	case 0
		DrawSprite(2)
		break
	case 1
		DrawSprite(3)
		DrawSpriteXY(0,Object.Value1,Object.Value2)
		break
	case 2
		DrawSprite(3)
		TempValue0=Object.YPos
		TempValue0-=0x240000
		DrawSpriteXY(Object.Frame,Object.XPos,TempValue0)
		break

	endswitch
	if Object.Value4>0
		TempValue0=0
		TempValue1=Object.Value5
		Sin(TempValue4,Object.Value6)
		TempValue4*=3
		Object.Value8=Object.Value6
		Object.Value8&=15
		Object.Value8>>=2
		Object.Value8+=Object.Value4
		while TempValue0<4
			Sin(TempValue2,TempValue1)
			TempValue2<<=12
			Cos(TempValue3,TempValue1)
			TempValue3<<=10
			Sin(TempValue5,TempValue1)
			TempValue5*=TempValue4
			TempValue3+=TempValue5
			TempValue2*=Object.Value7
			TempValue2>>=7
			TempValue3*=Object.Value7
			TempValue3>>=7
			TempValue2+=Object.XPos
			TempValue3+=Object.YPos
			TempValue3-=0x3C0000
			DrawSpriteXY(Object.Value8,TempValue2,TempValue3)
			TempValue0++
			TempValue1+=128
		loop
	endif
endsub


sub ObjectStartup
	LoadSpriteSheet("Global/Items.gif")
	SpriteFrame(-8,-8,16,16,1,137)
	SpriteFrame(-8,-8,16,16,1,202)
	SpriteFrame(-8,-44,16,64,1,137)
	SpriteFrame(-8,-28,16,48,1,153)
	SpriteFrame(-1,-1,3,3,76,214)
	SpriteFrame(-3,-3,7,7,68,214)
	SpriteFrame(-7,-7,15,15,52,214)
	SpriteFrame(-3,-3,7,7,68,214)
	SetArrayValue(18,DebugMode_constant25,DebugMode_array12)
	SetArrayValue(87,DebugMode_constant25,DebugMode_array13)
	SetArrayValue(88,DebugMode_constant25,DebugMode_array11)
	DebugMode_constant25++
	if starPostID>31
		ArrayPos0=starPostID
		PlayerObjectPos=0
		while PlayerObjectPos<PlayerObjectCount
			Object[PlayerObjectPos].XPos=Object[ArrayPos0].XPos
			Object[PlayerObjectPos].YPos=Object[ArrayPos0].YPos
			PlayerObjectPos++
		loop
		foreach TypeName[StarPost],ArrayPos1
			if Object[ArrayPos1].PropertyValue<Object[ArrayPos0].PropertyValue
				Object[ArrayPos1].State=1
				Object[ArrayPos1].Animation=2
				Object[ArrayPos1].Value0=0
			endif
		floop
		Screen.CameraXPos=Object[0].iXPos
		Screen.CameraYPos=Object[0].iYPos
		Object[ArrayPos0].State=1
		Object[ArrayPos0].Animation=2
		Stage.MilliSeconds=recMilliSeconds
		Stage.Seconds=recSeconds
		Stage.Minutes=recMinutes
	endif
endsub

sub RSDK
	LoadSpriteSheet("Global/Display.gif")
	SetEditorIcon(Icon0,SingleIcon,-16,-16,32,32,1,143)
endsub
