//--------------------Sonic 1 / Sonic 2 Water Script--------------------//
//--------Scripted by Christian Whitehead 'The Taxman' & Simon Thomley 'Stealth'--------//
//-----------------Unpacked By Rubberduckycooly's Script Unpacker-----------------------//

//-------Aliases-------//
#alias 43: TYPE_WATER

// Function declarations
#function Water_Function107
#function Water_Function108
#function Water_Function109

#constant 0:Water_constant38


//Unknown Variables
#constant 0:constant0x109AD

function Water_Function107
	if Object[+PlayerObjectPos].Value1>0
		Object[+PlayerObjectPos].Value1--
		if Object[+PlayerObjectPos].Value2>0
			Object[+PlayerObjectPos].Value2--
		else
			CreateTempObject(TypeName[AirBubble],2,Object[PlayerObjectPos].XPos,Object[PlayerObjectPos].YPos)
			Object[TempObjectPos].DrawOrder=4
			Object[TempObjectPos].YVelocity=-0x8800
			Object[TempObjectPos].Value2=PlayerObjectPos
			if Object[PlayerObjectPos].Direction==FLIP_NONE
				Object[TempObjectPos].XPos+=0x60000
			else
				Object[TempObjectPos].XPos-=0x60000
				Object[TempObjectPos].Angle=256
			endif
			Object[TempObjectPos].Value1=Object[TempObjectPos].XPos
			Object[+PlayerObjectPos].Value2=512
		endif
	else
		Rand(TempValue0,3)
		if TempValue0==1
			Rand(Object[+PlayerObjectPos].Value2,16)
			Object[+PlayerObjectPos].Value2+=8
		else
			Object[+PlayerObjectPos].Value2=512
		endif
		Object[+PlayerObjectPos].Value1=60
		CreateTempObject(TypeName[AirBubble],2,Object[PlayerObjectPos].XPos,Object[PlayerObjectPos].YPos)
		Object[TempObjectPos].DrawOrder=4
		Object[TempObjectPos].YVelocity=-0x8800
		Object[TempObjectPos].Value2=PlayerObjectPos
		if Object[PlayerObjectPos].Direction==FLIP_NONE
			Object[TempObjectPos].XPos+=0x60000
		else
			Object[TempObjectPos].XPos-=0x60000
			Object[TempObjectPos].Angle=256
		endif
		Object[TempObjectPos].Value1=Object[TempObjectPos].XPos
	endif
endfunction


function Water_Function108
	CreateTempObject(TypeName[CountdownBubble],TempValue0,Object[PlayerObjectPos].XPos,Object[PlayerObjectPos].YPos)
	Object[TempObjectPos].DrawOrder=5
	Object[TempObjectPos].YVelocity=-0x8800
	Object[TempObjectPos].Value2=PlayerObjectPos
	if Object[PlayerObjectPos].Direction==FLIP_NONE
		Object[TempObjectPos].XPos+=0x60000
	else
		Object[TempObjectPos].XPos-=0x60000
		Object[TempObjectPos].Angle=256
	endif
	Object[TempObjectPos].Value1=Object[TempObjectPos].XPos
endfunction


function Water_Function109
	if PlayerObjectPos==0
		ArrayPos0=Water_constant37
		ArrayPos0+=PlayerObjectPos
		if Object[PlayerObjectPos].Type!=TypeName[DeathEvent]
			if Music.CurrentTrack==6
				if Object[ArrayPos0].Value8==2
					ArrayPos1=PlayerObjectPos
					ArrayPos1+=PlayerObjectCount
					if Object[ArrayPos1].Type!=TypeName[Invincibility]
						if PlayerObject_constant3!=1
							Object[ArrayPos0].Value8=0
						endif
					endif
				endif
				PlayMusic(Object[ArrayPos0].Value8)
			endif
		endif
	endif
endfunction


sub ObjectMain
	TempValue0=Object[0].XPos
	TempValue0>>=16
	TempValue1=Object[0].YPos
	TempValue1>>=16
	ArrayPos0=Object.EntityNo
	if HPZSetup_constant36==0
		if Object.YPos<stage.newWaterLevel
			Object.YPos+=0x20000
		endif
		if Object.YPos>stage.newWaterLevel
			Object.YPos-=0x20000
		endif
		TempValue0=oscillation
		TempValue0<<=1
		Sin(Stage.WaterLevel,TempValue0)
		Stage.WaterLevel<<=10
		Stage.WaterLevel+=Object.YPos
		TempValue7=Stage.WaterLevel
		Stage.WaterLevel>>=16
	else
		Object.YPos=Stage.WaterLevel
		Object.YPos<<=16
		stage.newWaterLevel=Object.YPos
		TempValue7=Object.YPos
	endif
	PlayerObjectPos=0
	while PlayerObjectPos<PlayerObjectCount
		if Object[PlayerObjectPos].Value25==0x3800
			CheckNotEqual(Object[PlayerObjectPos].Type,TypeName[DebugMode])
			TempValue0=CheckResult
			CheckNotEqual(Object[PlayerObjectPos].State,28)
			TempValue0&=CheckResult
			CheckGreater(Object[PlayerObjectPos].YPos,TempValue7)
			TempValue0&=CheckResult
			if TempValue0==1
				if Object[PlayerObjectPos].YVelocity>0
					Object[PlayerObjectPos].YVelocity>>=2
				endif
				if Object.YPos<stage.newWaterLevel
					Object[PlayerObjectPos].YVelocity+=0x10000
				endif
				if Object[PlayerObjectPos].State==19
					StopSfx(SFXName[Flying])
					StopSfx(SFXName[Jump])
				endif
				Object[PlayerObjectPos].XVelocity>>=1
				Object[PlayerObjectPos].Speed>>=1
				CallFunction(PlayerObject_Function41)
				if Object[PlayerObjectPos].YVelocity!=0
					CreateTempObject(TypeName[WaterSplash],0,Object[PlayerObjectPos].XPos,TempValue7)
					Object[TempObjectPos].DrawOrder=4
					Object[PlayerObjectPos].Value18=4
					if Object[PlayerObjectPos].State!=1
						PlaySfx(SFXName[WaterSplash],0)
					endif
				endif
				Object[+PlayerObjectPos].Value1=52
				Object[PlayerObjectPos].Value3=0
			endif
		else
			if Object[PlayerObjectPos].Value7==0
				if Object[PlayerObjectPos].Value37==3
					TempValue2=0
					while TempValue2<8
						Rand(TempValue0,32)
						Rand(TempValue1,32)
						TempValue0-=16
						TempValue0<<=16
						TempValue0+=Object[PlayerObjectPos].XPos
						TempValue1-=16
						TempValue1<<=16
						TempValue1+=Object[PlayerObjectPos].YPos
						CreateTempObject(TypeName[DustPuff],0,TempValue0,TempValue1)
						Object[TempObjectPos].DrawOrder=Object[PlayerObjectPos].Value18
						Object[TempObjectPos].DrawOrder++
						Object[TempObjectPos].XVelocity=Object[PlayerObjectPos].XVelocity
						Object[TempObjectPos].YVelocity=Object[PlayerObjectPos].YVelocity
						TempValue2++
					loop
					Object[PlayerObjectPos].Value37=0
					ArrayPos0=PlayerObjectPos
					ArrayPos0+=PlayerObjectCount
					CallFunction(PlayerObject_Function37)
				endif
				if Object[PlayerObjectPos].Value37==4
					Object[PlayerObjectPos].Value37=0
					ArrayPos0=PlayerObjectPos
					ArrayPos0+=PlayerObjectCount
					CallFunction(PlayerObject_Function37)
					HPZSetup_constant33=4
				endif
			endif
			if Object[PlayerObjectPos].Value37!=2
				if Object[PlayerObjectPos].Value3==0
					Object[PlayerObjectPos].Value4=0
					CallFunction(Water_Function109)
				endif
				switch Object[PlayerObjectPos].Value4
				case 0
					CallFunction(Water_Function107)
					Object[PlayerObjectPos].Value3++
					if Object[PlayerObjectPos].Value3==360
						if PlayerObjectPos==0
							PlaySfx(SFXName[DrownAlert],0)
						endif
						Object[PlayerObjectPos].Value4++
					endif
					break
				case 1
					CallFunction(Water_Function107)
					Object[PlayerObjectPos].Value3++
					if Object[PlayerObjectPos].Value3==660
						if PlayerObjectPos==0
							PlaySfx(SFXName[DrownAlert],0)
						endif
						Object[PlayerObjectPos].Value4++
					endif
					break
				case 2
					CallFunction(Water_Function107)
					Object[PlayerObjectPos].Value3++
					if Object[PlayerObjectPos].Value3==960
						if PlayerObjectPos==0
							PlaySfx(SFXName[DrownAlert],0)
						endif
						Object[PlayerObjectPos].Value4++
					endif
					break
				case 3
					CallFunction(Water_Function107)
					Object[PlayerObjectPos].Value3++
					if Object[PlayerObjectPos].Value3==0x438
						if PlayerObjectPos==0
							Object.Value8=Music.CurrentTrack
							PlayMusic(6)
						endif
						TempValue0=0
						CallFunction(Water_Function108)
						Object[PlayerObjectPos].Value4++
					endif
					break
				case 4
					CallFunction(Water_Function107)
					Object[PlayerObjectPos].Value3++
					if Object[PlayerObjectPos].Value3==0x4B0
						TempValue0=1
						CallFunction(Water_Function108)
						Object[PlayerObjectPos].Value4++
					endif
					break
				case 5
					CallFunction(Water_Function107)
					Object[PlayerObjectPos].Value3++
					if Object[PlayerObjectPos].Value3==0x528
						TempValue0=2
						CallFunction(Water_Function108)
						Object[PlayerObjectPos].Value4++
					endif
					break
				case 6
					CallFunction(Water_Function107)
					Object[PlayerObjectPos].Value3++
					if Object[PlayerObjectPos].Value3==0x5A0
						TempValue0=3
						CallFunction(Water_Function108)
						Object[PlayerObjectPos].Value4++
					endif
					break
				case 7
					CallFunction(Water_Function107)
					Object[PlayerObjectPos].Value3++
					if Object[PlayerObjectPos].Value3==0x618
						TempValue0=4
						CallFunction(Water_Function108)
						Object[PlayerObjectPos].Value4++
					endif
					break
				case 8
					CallFunction(Water_Function107)
					Object[PlayerObjectPos].Value3++
					if Object[PlayerObjectPos].Value3==0x690
						TempValue0=5
						CallFunction(Water_Function108)
						Object[PlayerObjectPos].Value4++
					endif
					break
				case 9
					CallFunction(Water_Function107)
					Object[PlayerObjectPos].Value3++
					if Object[PlayerObjectPos].Value3==0x708
						if Object[PlayerObjectPos].State!=28
							if PlayerObjectPos==0
								Stage.TimeEnabled=0
								Screen.CameraEnabled=0
							endif
							Object[PlayerObjectPos].State=29
							Object[PlayerObjectPos].Animation=ANI_DROWNING
							Object[PlayerObjectPos].Speed=0
							Object[PlayerObjectPos].XVelocity=0
							Object[PlayerObjectPos].YVelocity=0
							Object[PlayerObjectPos].TileCollisions=0
							Object[PlayerObjectPos].ObjectInteractions=0
							Object[PlayerObjectPos].Value18=5
							Object[+PlayerObjectPos].Value1=2
							PlaySfx(SFXName[Drowning],0)
							Object[PlayerObjectPos].Value4++
						endif
					endif
					break
				case 10
					Object[PlayerObjectPos].Value3++
					if Object[PlayerObjectPos].Value3==0x744
						Object[PlayerObjectPos].Value4++
					endif
					if Object[+PlayerObjectPos].Value1>0
						Object[+PlayerObjectPos].Value1--
						if Object[+PlayerObjectPos].Value2>0
							Object[+PlayerObjectPos].Value2--
						else
							Rand(TempValue1,2)
							TempValue1+=2
							CreateTempObject(TypeName[AirBubble],TempValue1,Object[PlayerObjectPos].XPos,Object[PlayerObjectPos].YPos)
							Object[TempObjectPos].DrawOrder=5
							Object[TempObjectPos].YVelocity=-0x8800
							Object[TempObjectPos].YPos-=0x60000
							Object[TempObjectPos].Value2=PlayerObjectPos
							Rand(Object[TempObjectPos].Angle,256)
							Object[TempObjectPos].Value1=Object[TempObjectPos].XPos
							Object[+PlayerObjectPos].Value2=512
						endif
					else
						Rand(TempValue0,5)
						if TempValue0==1
							Object[+PlayerObjectPos].Value2=2
						else
							Object[+PlayerObjectPos].Value2=512
						endif
						Object[+PlayerObjectPos].Value1=6
						Rand(TempValue1,2)
						TempValue1+=2
						CreateTempObject(TypeName[AirBubble],TempValue1,Object[PlayerObjectPos].XPos,Object[PlayerObjectPos].YPos)
						Object[TempObjectPos].DrawOrder=5
						Object[TempObjectPos].YVelocity=-0x8800
						Object[TempObjectPos].YPos-=0x60000
						Object[TempObjectPos].Value2=PlayerObjectPos
						Rand(Object[TempObjectPos].Angle,256)
						Object[TempObjectPos].Value1=Object[TempObjectPos].XPos
					endif
					break

				endswitch
			endif
			CheckEqual(Object[PlayerObjectPos].Type,TypeName[DebugMode])
			TempValue0=CheckResult
			CheckLower(Object[PlayerObjectPos].YPos,TempValue7)
			TempValue0|=CheckResult
			if TempValue0==1
				if Object[PlayerObjectPos].State!=28
					Object[PlayerObjectPos].YVelocity<<=1
					if Object[PlayerObjectPos].YVelocity<-0x100000
						Object[PlayerObjectPos].YVelocity=-0x100000
					endif
					if Object[PlayerObjectPos].State==19
						if Object[PlayerObjectPos].Value1<480
							PlaySfx(SFXName[Flying],1)
						else
							PlaySfx(SFXName[Jump],1)
						endif
					endif
					CallFunction(PlayerObject_Function41)
					if Object[PlayerObjectPos].YVelocity!=0
						TempValue0=Object.YPos
						TempValue0-=Object[PlayerObjectPos].YPos
						if TempValue0<0xF00000
							CreateTempObject(TypeName[WaterSplash],0,Object[PlayerObjectPos].XPos,TempValue7)
							Object[TempObjectPos].DrawOrder=4
							Object[PlayerObjectPos].Value18=4
							if Object[PlayerObjectPos].State!=1
								PlaySfx(SFXName[WaterSplash],0)
							endif
						endif
					endif
					Object[PlayerObjectPos].Value3=0
					CallFunction(Water_Function109)
				endif
			endif
		endif
		PlayerObjectPos++
	loop
	Object.AnimationTimer++
	Object.AnimationTimer&=31
	Object.Frame=Object.AnimationTimer
	Object.Frame>>=3
endsub


sub ObjectDraw
	TempValue0=Screen.XOffset
	Sin(TempValue1,oscillation)
	TempValue1>>=5
	TempValue0+=TempValue1
	TempValue0&=63
	FlipSign(TempValue0)
	TempValue1=Stage.WaterLevel
	TempValue1-=Screen.YOffset
	DrawSpriteScreenFX(Object.Frame,FX_INK,TempValue0,TempValue1)
	TempValue0+=256
	DrawSpriteScreenFX(Object.Frame,FX_INK,TempValue0,TempValue1)
endsub


sub ObjectStartup
	foreach TypeName[Water],ArrayPos0
		Object[ArrayPos0].Priority=PRIORITY_ACTIVE
		Object[ArrayPos0].DrawOrder=5
		Object[ArrayPos0].InkEffect=INK_ALPHA
		Object[ArrayPos0].Alpha=160
		stage.newWaterLevel=Object[ArrayPos0].YPos
		Water_constant37=ArrayPos0
		Stage.WaterLevel=stage.newWaterLevel
		Stage.WaterLevel>>=16
		Object[ArrayPos0].YPos=stage.newWaterLevel
	floop
	if starPostID>31
		stage.waterState=recWaterState
		Stage.WaterLevel=recWaterLevel
		stage.newWaterLevel=recWaterLevel
		stage.newWaterLevel<<=16
		ArrayPos0=Water_constant37
		Object[ArrayPos0].YPos=stage.newWaterLevel
	else
		stage.waterState=0
	endif
	Water_constant38=0
	foreach TypeName[256],PlayerObjectPos
		Object[PlayerObjectPos].Value3=0
		if Object[PlayerObjectPos].YPos>stage.newWaterLevel
			Object[PlayerObjectPos].YVelocity>>=2
			Object[PlayerObjectPos].XVelocity>>=1
			Object[PlayerObjectPos].Speed>>=1
			Object[PlayerObjectPos].Value20>>=1
			Object[PlayerObjectPos].Value21>>=1
			Object[PlayerObjectPos].Value22>>=1
			Object[PlayerObjectPos].Value23>>=1
			Object[PlayerObjectPos].Value24>>=1
			Object[PlayerObjectPos].Value25=0x1000
			if Stage.PlayerListPos==2
				Object[PlayerObjectPos].Value27=0x30000
			else
				Object[PlayerObjectPos].Value27=0x38000
			endif
			Object[PlayerObjectPos].Value28=-0x20000
			ArrayPos0=Water_constant37
			ArrayPos0+=PlayerObjectPos
			Object[ArrayPos0].Value1=52
		endif
	floop
	LoadSpriteSheet("HPZ/Objects2.gif")
	SpriteFrame(0,-8,256,16,0,0)
	SpriteFrame(0,-8,256,16,0,16)
	SpriteFrame(0,-8,256,16,0,32)
	SpriteFrame(0,-8,256,16,0,48)
	BrokenMonitor_constant27=109
endsub

sub RSDK
	LoadSpriteSheet("Global/Display.gif")
	SetEditorIcon(Icon0,SingleIcon,-16,-16,32,32,1,143)
endsub
