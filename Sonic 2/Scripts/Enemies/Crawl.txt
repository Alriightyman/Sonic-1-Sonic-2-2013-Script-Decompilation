//--------------------Sonic 1 / Sonic 2 Crawl Script--------------------//
//--------Scripted by Christian Whitehead 'The Taxman' & Simon Thomley 'Stealth'--------//
//-----------------Unpacked By Rubberduckycooly's Script Unpacker-----------------------//

//-------Aliases-------//
#alias 55: TYPE_CRAWL

// Function declarations
#function Crawl_Function131
#function Crawl_Function132
#function Crawl_Function133
#function Crawl_Function134



function Crawl_Function131
	DrawSpriteFX(0,FX_FLIP,Object.XPos,Object.YPos)
endfunction


function Crawl_Function132
	CreateTempObject(TypeName[Crawl],0,Object.XPos,Object.YPos)
	Object[TempObjectPos].Value1=Object.XPos
	Object[TempObjectPos].Value2=Object.YPos
	Object[TempObjectPos].Direction=Object.Direction
endfunction


function Crawl_Function133
	Object.Value3=0
	foreach TypeGroup[256],PlayerObjectPos
		TempValue0=Object[PlayerObjectPos].XPos
		TempValue0-=Object.XPos
		Absolute(TempValue0)
		if TempValue0<0x400000
			TempValue0=Object[PlayerObjectPos].YPos
			TempValue0-=Object.YPos
			Absolute(TempValue0)
			if TempValue0<0x400000
				Object.Value3|=1
			endif
		endif
	floop
endfunction


function Crawl_Function134
	TempValue0=Object[PlayerObjectPos].XPos
	TempValue0-=Object.XPos
	TempValue1=Object[PlayerObjectPos].YPos
	TempValue1-=Object.YPos
	ATan2(TempValue2,TempValue0,TempValue1)
	Cos256(TempValue0,TempValue2)
	Sin256(TempValue1,TempValue2)
	TempValue0*=0x700
	TempValue1*=0x700
	Object[PlayerObjectPos].Value1=0
	Object[PlayerObjectPos].Speed=TempValue0
	Object[PlayerObjectPos].XVelocity=TempValue0
	Object[PlayerObjectPos].YVelocity=TempValue1
	PlaySfx(SFXName[Bumper],0)
endfunction


sub ObjectMain
	switch Object.State
	case 0
		if Object.Priority!=PRIORITY_XBOUNDS_DESTROY
			Object.Priority=PRIORITY_ACTIVE
		endif
		if Object.Direction==FLIP_NONE
			Object.XVelocity=-0x2000
		else
			Object.XVelocity=0x2000
		endif
		Object.State=1
		break
	case 1
		Object.XPos+=Object.XVelocity
		ObjectTileGrip(CMODE_FLOOR,0,16,0)
		Object.Value0++
		if Object.Value0==512
			Object.Value0=0
			Object.State=2
		endif
		CallFunction(Crawl_Function133)
		if Object.Value3==1
			Object.Value4=Object.State
			Object.State=3
			Object.Frame=0
			Object.AnimationTimer=0
		endif
		Object.Frame=Object.AnimationTimer
		Object.Frame/=20
		Object.AnimationTimer++
		Object.AnimationTimer%=40
		break
	case 2
		Object.Value0++
		if Object.Value0==60
			Object.Value0=0
			Object.Direction^=FLIP_X
			FlipSign(Object.XVelocity)
			Object.State=1
		endif
		CallFunction(Crawl_Function133)
		if Object.Value3==1
			Object.Value4=Object.State
			Object.State=3
		endif
		Object.Frame=0
		Object.AnimationTimer=0
		break
	case 3
		CallFunction(Crawl_Function133)
		if Object.Value3==0
			Object.State=Object.Value4
		endif
		Object.AnimationTimer=0
		break

	endswitch
	if Object.OutOfBounds==1
		TempValue0=Object.XPos
		TempValue1=Object.YPos
		Object.XPos=Object.Value1
		Object.YPos=Object.Value2
		if Object.OutOfBounds==1
			if Object.Priority!=PRIORITY_XBOUNDS_DESTROY
				Object.Priority=PRIORITY_ACTIVE_BOUNDS
			endif
			Object.State=0
		else
			Object.XPos=TempValue0
			Object.YPos=TempValue1
		endif
	endif
	foreach TypeGroup[256],PlayerObjectPos
		PlayerObjectCollision(C_TOUCH,Object.EntityNo,-15,-16,15,16,PlayerObjectPos,Object[PlayerObjectPos].Value40,Object[PlayerObjectPos].Value38,Object[PlayerObjectPos].Value41,Object[PlayerObjectPos].Value39)
		if CheckResult==1
			if Object[PlayerObjectPos].Animation==ANI_JUMPING
				if Object[PlayerObjectPos].Gravity==GRAVITY_AIR
					CallFunction(Crawl_Function134)
					Object.Frame=3
				else
					if Object.Direction==FLIP_NONE
						if Object[PlayerObjectPos].XPos>Object.XPos
							CallFunction(PlayerObject_Function44)
						else
							CallFunction(Crawl_Function134)
							Object.Frame=2
						endif
					else
						if Object[PlayerObjectPos].XPos<Object.XPos
							CallFunction(PlayerObject_Function44)
						else
							CallFunction(Crawl_Function134)
							Object.Frame=2
						endif
					endif
				endif
			else
				CallFunction(PlayerObject_Function44)
			endif
		endif
	floop
endsub


sub ObjectDraw
	DrawSpriteFX(Object.Frame,FX_FLIP,Object.XPos,Object.YPos)
endsub


sub ObjectStartup
	CheckStageFolder("Zone04")
	if CheckResult==1
		LoadSpriteSheet("CNZ/Objects.gif")
		SpriteFrame(-23,-16,47,32,1,1)
		SpriteFrame(-31,-16,59,32,49,1)
		SpriteFrame(-24,-16,40,32,109,1)
		SpriteFrame(-32,-16,48,32,150,1)
	else
		LoadSpriteSheet("MBZ/Objects.gif")
		SpriteFrame(-23,-16,47,32,436,256)
		SpriteFrame(-31,-16,59,32,484,256)
		SpriteFrame(-24,-16,40,32,544,256)
		SpriteFrame(-32,-16,48,32,585,256)
	endif
	foreach TypeName[Crawl],ArrayPos0
		Object[ArrayPos0].Value1=Object[ArrayPos0].XPos
		Object[ArrayPos0].Value2=Object[ArrayPos0].YPos
	floop
	SetArrayValue(55,DebugMode_constant25,DebugMode_array12)
	SetArrayValue(131,DebugMode_constant25,DebugMode_array13)
	SetArrayValue(132,DebugMode_constant25,DebugMode_array11)
	DebugMode_constant25++
endsub

sub RSDK
	LoadSpriteSheet("Global/Display.gif")
	SetEditorIcon(Icon0,SingleIcon,-16,-16,32,32,1,143)
endsub
