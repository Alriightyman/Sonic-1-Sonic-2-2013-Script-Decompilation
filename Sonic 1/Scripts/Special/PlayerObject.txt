//--------------------Sonic 1 / Sonic 2 Player Object Script--------------------//
//--------Scripted by Christian Whitehead 'The Taxman' & Simon Thomley 'Stealth'--------//
//-----------------Unpacked By Rubberduckycooly's Script Unpacker-----------------------//

//-------Aliases-------//
#alias 1: TYPE_PLAYEROBJECT

// Function declarations
#function PlayerObject_InitSpecialRpy
#function PlayerObject_Function0
#function PlayerObject_Blank
#function PlayerObject_Function2
#function PlayerObject_Function5
#function PlayerObject_Function6
#function PlayerObject_Function3

#static 0:PlayerObject_staticVar6
#static 0:PlayerObject_staticVar7
#static 0:PlayerObject_staticVar8
#static 0:PlayerObject_staticVar9
#static 0:PlayerObject_ReplayData
#static 0:PlayerObject_AttractArrIndex
#static 0:PlayerObject_AttractArrSize
#static 0:PlayerObject_AttractTimer
#static 0:PlayerObject_SkipAttract
#static 0:PlayerObject_staticVar5
#static 0:constant9
#static 0:constant10
#static 0:constant11
#static 0:constant12
#static 0:constant13
#static 0:constant14
#static 0:constant15

function PlayerObject_InitSpecialRpy
	PlayerObject_AttractArrIndex=2
	PlayerObject_AttractTimer=1
	PlayerObjectPos=0
	while PlayerObjectPos<PlayerObjectCount
		GetArrayValue(Object[PlayerObjectPos].XPos,0,PlayerObject_ReplayData)
		GetArrayValue(Object[PlayerObjectPos].YPos,1,PlayerObject_ReplayData)
		Object[PlayerObjectPos].ControlMode=-1
		Object[PlayerObjectPos].Up=0
		Object[PlayerObjectPos].Down=0
		Object[PlayerObjectPos].Left=0
		Object[PlayerObjectPos].Right=0
		Object[PlayerObjectPos].JumpPress=0
		Object[PlayerObjectPos].JumpHold=0
		Object[PlayerObjectPos].Value1=0
		PlayerObjectPos++
	loop
	Screen.CameraXPos=Object[0].iXPos
	Screen.CameraYPos=Object[0].iYPos
endfunction


function PlayerObject_Function0
	if options.attractMode==0
		if options.touchControls==1
			if Object.ControlMode==0
				CheckTouchRect(0,96,Screen.CenterX,Screen.YSize)
				if CheckResult>-1
					ArrayPos0=CheckResult
					TempValue0=TouchScreen[ArrayPos0].XPos
					TempValue0-=SaveRAM[39]
					TempValue1=TouchScreen[ArrayPos0].YPos
					TempValue1-=SaveRAM[40]
					ATan2(TempValue2,TempValue0,TempValue1)
					TempValue2+=32
					TempValue2&=255
					TempValue2>>=6
					switch TempValue2
					case 0
						KeyDown.Right=1
						break
					case 1
						KeyDown.Down=1
						break
					case 2
						KeyDown.Left=1
						break
					case 3
						KeyDown.Up=1
						break

					endswitch
				endif
				CheckTouchRect(Screen.CenterX,96,Screen.XSize,240)
				if CheckResult>-1
					KeyDown.ButtonA=1
				endif
				if touchJump==0
					KeyPress.ButtonA|=KeyDown.ButtonA
				endif
				touchJump=KeyDown.ButtonA
				if Stage.DebugMode==1
					CheckTouchRect(0,0,112,56)
					if CheckResult>-1
						KeyDown.ButtonB=1
					endif
					if touchDebug==0
						KeyPress.ButtonB|=KeyDown.ButtonB
					endif
					touchDebug=KeyDown.ButtonB
				endif
				CheckTouchRect(240,0,Screen.XSize,40)
				if CheckResult>-1
					PlaySfx(SFXName[MenuBack],0)
					Engine.State=5
				endif
				if KeyPress.Start==1
					PlaySfx(SFXName[MenuBack],0)
					Engine.State=5
				endif
			endif
		endif
		ProcessPlayerControl()
	else
		CheckTouchRect(0,0,Screen.XSize,Screen.YSize)
		if KeyPress.Start==1
			CheckResult=0
		endif
		if CheckResult>-1
			if PlayerObject_SkipAttract>1
				PlayerObject_SkipAttract=1
			endif
		endif
		if KeyPress.Start==1
			PlayerObject_SkipAttract=1
		endif
		PlayerObject_AttractTimer--
		if PlayerObject_AttractTimer<1
			if PlayerObject_AttractArrIndex<PlayerObject_AttractArrSize
				GetArrayValue(TempValue0,PlayerObject_AttractArrIndex,PlayerObject_ReplayData)
				GetBit(Object.Up,TempValue0,0)
				GetBit(Object.Down,TempValue0,1)
				GetBit(Object.Left,TempValue0,2)
				GetBit(Object.Right,TempValue0,3)
				GetBit(Object.JumpPress,TempValue0,4)
				GetBit(Object.JumpHold,TempValue0,5)
				PlayerObject_AttractArrIndex++
				GetArrayValue(PlayerObject_AttractTimer,PlayerObject_AttractArrIndex,PlayerObject_ReplayData)
				PlayerObject_AttractArrIndex++
			endif
		else
			if Object.JumpPress==1
				Object.JumpPress=0
			endif
		endif
		if PlayerObject_SkipAttract>0
			PlayerObject_SkipAttract--
			if PlayerObject_SkipAttract<1
				ArrayPos0=PlayerObject_staticVar5
				Object[ArrayPos0].Type=TypeName[TitleCard]
				Object[ArrayPos0].State=8
				Object[ArrayPos0].Priority=PRIORITY_ACTIVE
				Object[ArrayPos0].DrawOrder=6
			endif
		endif
	endif
endfunction


function PlayerObject_Blank
	CheckResult=0
endfunction


function PlayerObject_Function2
	if Stage.PlayerListPos==1
		Object.AnimationSpeed=120
	else
		Object.AnimationSpeed=Object.Value2
		Absolute(Object.AnimationSpeed)
		Object.AnimationSpeed*=240
		Object.AnimationSpeed/=0x60000
		Object.AnimationSpeed+=48
	endif
endfunction


function PlayerObject_Function5
	if Object.Value12>0
		GetBit(TempValue0,Object.Value11,2)
	else
		GetBit(TempValue0,Object.Value11,3)
	endif
	if TempValue0!=0
		Object.Value12=0
		Object.Gravity=GRAVITY_GROUND
	endif
	if Object.Value13>0
		GetBit(TempValue0,Object.Value11,1)
	else
		GetBit(TempValue0,Object.Value11,4)
	endif
	if TempValue0!=0
		Object.Value13=0
		Object.Gravity=GRAVITY_GROUND
	endif
endfunction


function PlayerObject_Function6
	TempValue0=PlayerObject_staticVar6
	TempValue0>>=1
	TempValue0-=224
	TempValue0&=192
	switch TempValue0
	case 0
		if Object.Value2>0
			GetBit(TempValue0,Object.Value11,2)
		else
			GetBit(TempValue0,Object.Value11,3)
		endif
		break
	case 64
		if Object.Value2>0
			GetBit(TempValue0,Object.Value11,1)
		else
			GetBit(TempValue0,Object.Value11,4)
		endif
		break
	case 128
		if Object.Value2>0
			GetBit(TempValue0,Object.Value11,3)
		else
			GetBit(TempValue0,Object.Value11,2)
		endif
		break
	case 192
		if Object.Value2>0
			GetBit(TempValue0,Object.Value11,4)
		else
			GetBit(TempValue0,Object.Value11,1)
		endif
		break

	endswitch
	if TempValue0==1
		Object.Value2=0
	endif
	Object.Value11=0
endfunction


function PlayerObject_Function3
	CallFunction(PlayerObject_Function5)
	if Object.Gravity==GRAVITY_AIR
		if Object.Value14!=0
			Object.Value14--
		endif
		if Object.Value15!=0
			Object.Value15--
		endif
	endif
	TempValue2=PlayerObject_staticVar6
	TempValue2&=504
	if Object.Gravity==GRAVITY_GROUND
		if Object.JumpPress==1
			CheckResult=1
		else
			CheckResult=0
		endif
	else
		CheckResult=0
	endif
	if CheckResult==1
		Sin(TempValue0,TempValue2)
		TempValue0*=Object.Value7
		TempValue0>>=9
		Cos(TempValue1,TempValue2)
		TempValue1*=Object.Value7
		TempValue1>>=9
		Object.Value12=0
		Object.Value12+=TempValue0
		Object.Value13=0
		Object.Value13-=TempValue1
		PlaySfx(SFXName[Jump],0)
	else
		Sin(TempValue0,TempValue2)
		TempValue0*=Object.Value5
		TempValue0>>=9
		Cos(TempValue1,TempValue2)
		TempValue1*=Object.Value5
		TempValue1>>=9
		Object.Value12-=TempValue0
		Object.Value13+=TempValue1
	endif
	CallFunction(PlayerObject_Function6)
	TempValue0=0
	if Object.Left==1
		Object.Value2-=Object.Value3
		if Object.Value2<-0x80000
			Object.Value2=-0x80000
		endif
		Object.Direction=FLIP_X
		TempValue0=1
	endif
	if Object.Right==1
		Object.Value2+=Object.Value3
		if Object.Value2>0x80000
			Object.Value2=0x80000
		endif
		Object.Direction=FLIP_NONE
		TempValue0=1
	endif
	if TempValue0==0
		if Object.Value2!=0
			if Object.Value2>0
				Object.Value2-=Object.Value3
				if Object.Value2<0
					Object.Value2=0
				endif
			else
				Object.Value2+=Object.Value3
				if Object.Value2>0
					Object.Value2=0
				endif
			endif
		endif
	endif
	TempValue0=PlayerObject_staticVar6
	TempValue0+=64
	TempValue0&=384
	Cos(Object.Value8,TempValue0)
	Object.Value8*=Object.Value2
	Object.Value8>>=9
	Sin(Object.Value9,TempValue0)
	Object.Value9*=Object.Value2
	Object.Value9>>=9
	Object.XVelocity=Object.Value12
	Object.XVelocity+=Object.Value8
	Object.YVelocity=Object.Value13
	Object.YVelocity+=Object.Value9
	CallFunction(PlayerObject_Function2)
endfunction


sub ObjectMain
	if Stage.DebugMode==1
		CallFunction(PlayerObject_Function0)
		if KeyPress.ButtonB==1
			Object.Type=TypeName[DebugMode]
			if Stage.PlayerListPos==1
				Object[+1].Type=TypeName[BlankObject]
			endif
			Object.Value2=0
			Object.Rotation=0
			Object.Frame=0
			PlayerObject_staticVar6=0
			PlayerObject_staticVar7=2
			Object.Frame=Object.Value10
			Object.ObjectInteractions=0
		else
			CallFunction(Object.State)
			ProcessObjectAnimation()
			if Object.State!=1
				PlayerTileCollision()
			endif
			Object.Gravity=GRAVITY_AIR
		endif
	else
		CallFunction(PlayerObject_Function0)
		CallFunction(Object.State)
		ProcessObjectAnimation()
		if Object.State!=1
			PlayerTileCollision()
		endif
		Object.Gravity=GRAVITY_AIR
	endif
endsub


sub ObjectDraw
	DrawObjectAnimation()
endsub


sub ObjectStartup
	LoadSpriteSheet("Global/Display.gif")
	foreach TypeName[PlayerObject],ArrayPos0
		if Stage.PlayerListPos>2
			Stage.PlayerListPos=0
			stage.player2Enabled=1
		endif
		ResetObjectEntity(0,TypeName[PlayerObject],0,Object[ArrayPos0].XPos,Object[ArrayPos0].YPos)
		Screen.CameraXPos=Object[0].iXPos
		Screen.CameraYPos=Object[0].iYPos
		Object[0].TypeGroup=256
		Object[0].XVelocity=0
		Object[0].YVelocity=0
		Object[0].Speed=0
		PlayerObject_staticVar5=Object.EntityNo
		switch Stage.PlayerListPos
		case 0
			LoadAnimation("SonicSS.ani")
			Object[0].AnimationSpeed=48
			break
		case 1
			LoadAnimation("TailsSS.ani")
			Object[0].AnimationSpeed=120
			break
		case 2
			LoadAnimation("KnucklesSS.ani")
			Object[0].AnimationSpeed=48
			break
		endswitch
		Object[0].State=PlayerObject_Function3
		Object[0].Priority=PRIORITY_ACTIVE
		Object[0].DrawOrder=4
		Object[0].Value3=0xC00
		Object[0].Value7=0x68000
		Object[0].Value5=0x2A00
		ResetObjectEntity(ArrayPos0,TypeName[BlankObject],0,0,0)
		Object[0].TileCollisions=0
		Object[0].Gravity=GRAVITY_AIR
		PlayerObject_staticVar6=0
		PlayerObject_staticVar7=0
		PlayerObject_staticVar8=0
		PlayerObject_staticVar9=0
	floop
	options.touchControls=1
endsub

sub RSDK
	LoadSpriteSheet("Global/Display.gif")
	SetEditorIcon(Icon0,SingleIcon,-16,-16,32,32,1,143)
endsub
